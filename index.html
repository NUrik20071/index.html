<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω–∫–∞</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        input, button { display: block; width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box; }
        .hidden { display: none; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; }
        .product-entry { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        h2 { font-size: 24px; margin: 20px 0; }

        /* –°—Ç–∏–ª—å —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
        #product-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 20px; 
            text-align: left; 
            margin-top: 20px; 
        }
        .product-item { 
            border: 1px solid #ddd; 
            padding: 10px; 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            position: relative; 
        }
        .product-item img { 
            width: 100%; 
            height: 150px; 
            object-fit: contain; 
            border-radius: 4px; 
        }
        .product-item .discount { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: #ff6200; 
            color: #fff; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
        }
        .product-item .price { 
            font-size: 18px; 
            font-weight: bold; 
            color: #000; 
        }
        .product-item .old-price { 
            font-size: 14px; 
            color: #888; 
            text-decoration: line-through; 
            margin-left: 5px; 
        }
        .product-item .name { 
            font-size: 14px; 
            color: #333; 
            margin: 5px 0; 
            height: 40px; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .product-item .cart-btn { 
            background: #007bff; 
            color: #fff; 
            border: none; 
            padding: 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .product-item .cart-btn::before { 
            content: "üõí"; 
            margin-right: 5px; 
        }
        .product-item .cart-btn:hover { 
            background: #0056b3; 
        }
        .product-item input[type="checkbox"] { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
        }
    </style>
</head>
<body>

    <h1>–ê–¥–º–∏–Ω–∫–∞</h1>

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div id="auth-section">
        <button onclick="authenticate()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
    </div>

    <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
    <div id="admin-section" class="hidden">
        <img id="avatar" class="avatar">
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã</h2>
        <div class="container" id="products-container">
            <div class="product-entry">
                <input type="text" class="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                <input type="number" class="price" placeholder="–¶–µ–Ω–∞">
                <div class="photo-container">
                    <input type="file" class="fileInput" accept="image/*" multiple>
                </div>
                <button onclick="addPhotoField(this)">–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ñ–æ—Ç–æ</button>
            </div>
        </div>
        <button onclick="addProductEntry()">–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ç–æ–≤–∞—Ä</button>
        <button onclick="addProducts()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã</button>

        <!-- –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ -->
        <h2>–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <div class="container">
            <input type="file" id="bulkUpload" accept=".json">
            <button onclick="bulkUploadProducts()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ JSON</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
        <h2>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <div id="product-list" class="container"></div>

        <h2>–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
        <div class="container">
            <input type="text" id="deleteId" placeholder="ID —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è">
            <button onclick="deleteProduct()">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
        </div>
    </div>

    <script>
        const CLIENT_ID = "–í–ê–®_–†–ï–ê–õ–¨–ù–´–ô_CLIENT_ID.apps.googleusercontent.com"; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à Client ID
        const SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile";
        const FOLDER_ID = "17tKKmWurcoRZi96oI7ujB25uMNhUOy78";
        let accessToken = localStorage.getItem("access_token");

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        function authenticate() {
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                prompt: 'select_account',
                callback: (tokenResponse) => {
                    if (tokenResponse.error) {
                        console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", tokenResponse.error, tokenResponse.error_description);
                        alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: " + tokenResponse.error_description);
                        return;
                    }
                    accessToken = tokenResponse.access_token;
                    localStorage.setItem("access_token", accessToken);
                    fetchUserInfo();
                    fetchProducts();
                },
            });
            tokenClient.requestAccessToken();
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function fetchUserInfo() {
            fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
                headers: { Authorization: `Bearer ${accessToken}` }
            })
            .then(res => res.json())
            .then(user => {
                document.getElementById("auth-section").classList.add("hidden");
                document.getElementById("admin-section").classList.remove("hidden");
                document.getElementById("avatar").src = user.picture;
            })
            .catch(() => {
                localStorage.removeItem("access_token");
                alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
            });
        }

        if (accessToken) {
            fetchUserInfo();
            fetchProducts();
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –¥–ª—è —Ñ–æ—Ç–æ
        function addPhotoField(button) {
            const container = button.previousElementSibling;
            const newInput = document.createElement("input");
            newInput.type = "file";
            newInput.className = "fileInput";
            newInput.accept = "image/*";
            newInput.multiple = true;
            container.appendChild(newInput);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞
        function addProductEntry() {
            const container = document.getElementById("products-container");
            const newEntry = document.createElement("div");
            newEntry.className = "product-entry";
            newEntry.innerHTML = `
                <input type="text" class="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                <input type="number" class="price" placeholder="–¶–µ–Ω–∞">
                <div class="photo-container">
                    <input type="file" class="fileInput" accept="image/*" multiple>
                </div>
                <button onclick="addPhotoField(this)">–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ñ–æ—Ç–æ</button>
            `;
            container.appendChild(newEntry);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
        async function addProducts() {
            if (!accessToken) return alert("–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!");

            const entries = document.getElementsByClassName("product-entry");
            for (let entry of entries) {
                let name = entry.querySelector(".name").value.trim();
                let price = entry.querySelector(".price").value.trim();
                let fileInputs = entry.querySelectorAll(".fileInput");
                let files = Array.from(fileInputs).flatMap(input => Array.from(input.files)).filter(file => file);

                if (!name || !price) {
                    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞!");
                    return;
                }

                let imageIds = [];
                for (let file of files) {
                    let metadata = { name: file.name, mimeType: file.type, parents: [FOLDER_ID] };
                    let formData = new FormData();
                    formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
                    formData.append("file", file);

                    let response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                        method: "POST",
                        headers: { Authorization: `Bearer ${accessToken}` },
                        body: formData
                    });
                    let data = await response.json();
                    imageIds.push(data.id);
                }

                let productId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                let productData = JSON.stringify({ id: productId, name, price, image: imageIds });
                await createProductFile(productId, productData);
            }
            alert("–¢–æ–≤–∞—Ä—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã!");
            fetchProducts();
            clearForm();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Ç–æ–≤–∞—Ä–∞
        async function createProductFile(productId, productData) {
            let metadata = { name: `${productId}.txt`, mimeType: "text/plain", parents: [FOLDER_ID] };
            let formData = new FormData();
            formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            formData.append("file", new Blob([productData], { type: "text/plain" }));

            let response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST",
                headers: { Authorization: `Bearer ${accessToken}` },
                body: formData
            });
            let data = await response.json();
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        function clearForm() {
            const container = document.getElementById("products-container");
            container.innerHTML = `
                <div class="product-entry">
                    <input type="text" class="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                    <input type="number" class="price" placeholder="–¶–µ–Ω–∞">
                    <div class="photo-container">
                        <input type="file" class="fileInput" accept="image/*" multiple>
                    </div>
                    <button onclick="addPhotoField(this)">–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ñ–æ—Ç–æ</button>
                </div>
            `;
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function deleteProduct() {
            if (!accessToken) return alert("–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!");
            let deleteId = document.getElementById("deleteId").value.trim();
            if (!deleteId) return alert("–í–≤–µ–¥–∏—Ç–µ ID —Ç–æ–≤–∞—Ä–∞!");

            let response = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${deleteId}.txt'&spaces=drive`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            let data = await response.json();
            if (data.files.length > 0) {
                let fileId = data.files[0].id;
                await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                alert("–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω!");
                fetchProducts();
            } else {
                alert("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        async function fetchProducts() {
            if (!accessToken) return;
            let response = await fetch(`https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'%20in%20parents&fields=files(id,name)`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            let data = await response.json();
            const productList = document.getElementById("product-list");
            productList.innerHTML = "";

            for (let file of data.files) {
                if (file.name.endsWith(".txt")) {
                    let fileResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                        headers: { Authorization: `Bearer ${accessToken}` }
                    });
                    let productData = await fileResponse.json();
                    let div = document.createElement("div");
                    div.className = "product-item";
                    // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –¥–æ–±–∞–≤–∏–º —Å–ª—É—á–∞–π–Ω—É—é —Å–∫–∏–¥–∫—É
                    let discount = Math.floor(Math.random() * 30) + 10;
                    let oldPrice = Math.round(productData.price * (1 + discount / 100));
                    div.innerHTML = `
                        <input type="checkbox" name="product" value="${productData.id}">
                        ${productData.image.length > 0 ? `<img src="https://drive.google.com/thumbnail?id=${productData.image[0]}" alt="–§–æ—Ç–æ">` : '<img src="https://via.placeholder.com/150" alt="–ù–µ—Ç —Ñ–æ—Ç–æ">'}
                        <div class="discount">–†–ê–°–°–†–û–ß–ö–ê 0-0-6</div>
                        <div class="price">${productData.price} ‚ÇΩ <span class="old-price">${oldPrice} ‚ÇΩ</span></div>
                        <div class="name">${productData.name}</div>
                        <button class="cart-btn">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    `;
                    productList.appendChild(div);
                }
            }
        }

        // –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ JSON
        async function bulkUploadProducts() {
            if (!accessToken) return alert("–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!");
            const fileInput = document.getElementById("bulkUpload");
            const file = fileInput.files[0];
            if (!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ JSON-—Ñ–∞–π–ª!");

            const reader = new FileReader();
            reader.onload = async (e) => {
                const products = JSON.parse(e.target.result);
                for (let product of products) {
                    let productId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                    let productData = JSON.stringify({
                        id: productId,
                        name: product.name,
                        price: product.price,
                        image: product.image || []
                    });
                    await createProductFile(productId, productData);
                }
                alert("–¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");
                fetchProducts();
            };
            reader.readAsText(file);
        }
    </script>

</body>
</html>
