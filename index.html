<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { max-width: 400px; margin: auto; }
        input, button { display: block; width: 100%; margin: 10px 0; padding: 10px; }
        .hidden { display: none; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; }
        #photo-container { margin: 10px 0; }
    </style>
</head>
<body>

    <h1>Админка</h1>

    <!-- Авторизация -->
    <div id="auth-section">
        <button onclick="authenticate()">Авторизоваться</button>
    </div>

    <!-- Админ-панель -->
    <div id="admin-section" class="hidden">
        <img id="avatar" class="avatar">
        <h2>Добавить товар</h2>
        <div class="container">
            <input type="text" id="name" placeholder="Название товара">
            <input type="number" id="price" placeholder="Цена">

            <!-- Загрузка фото -->
            <div id="photo-container">
                <input type="file" class="fileInput" accept="image/*">
            </div>
            <button onclick="addPhotoField()">Добавить фото товара</button>
            <button onclick="uploadImages()">Загрузить все фото</button>
            <input type="text" id="image" placeholder="ID изображений (через запятую)" readonly>

            <button onclick="addProduct()">Добавить товар</button>
        </div>

        <h2>Удалить товар</h2>
        <div class="container">
            <input type="text" id="deleteId" placeholder="ID товара для удаления">
            <button onclick="deleteProduct()">Удалить товар</button>
        </div>
    </div>

    <script>
        const CLIENT_ID = "ТВОЙ_CLIENT_ID.apps.googleusercontent.com";
        const SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile"; // Добавлен scope для профиля
        const FOLDER_ID = "ТВОЙ_ID_ПАПКИ"; // ID папки в Google Drive
        let accessToken = localStorage.getItem("access_token");
        let imageIds = []; // Массив для хранения ID загруженных изображений

        // Авторизация с выбором аккаунта
        function authenticate() {
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                prompt: 'select_account', // Заставляет показывать выбор аккаунта
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    localStorage.setItem("access_token", accessToken);
                    fetchUserInfo();
                },
            });
            tokenClient.requestAccessToken();
        }

        // Получение данных пользователя
        function fetchUserInfo() {
            fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
                headers: { Authorization: `Bearer ${accessToken}` }
            })
            .then(res => res.json())
            .then(user => {
                document.getElementById("auth-section").classList.add("hidden");
                document.getElementById("admin-section").classList.remove("hidden");
                document.getElementById("avatar").src = user.picture;
            })
            .catch(() => {
                localStorage.removeItem("access_token");
                alert("Ошибка авторизации. Попробуйте снова.");
            });
        }

        if (accessToken) fetchUserInfo();

        // Добавление нового поля для фото
        function addPhotoField() {
            const container = document.getElementById("photo-container");
            const newInput = document.createElement("input");
            newInput.type = "file";
            newInput.className = "fileInput";
            newInput.accept = "image/*";
            container.appendChild(newInput);
        }

        // Загрузка всех фото в Google Drive
        async function uploadImages() {
            if (!accessToken) return alert("Авторизуйтесь!");

            const fileInputs = document.getElementsByClassName("fileInput");
            const files = Array.from(fileInputs).map(input => input.files[0]).filter(file => file);
            if (files.length === 0) return alert("Выберите хотя бы одно фото!");

            imageIds = []; // Очищаем массив перед загрузкой
            for (let file of files) {
                let metadata = {
                    name: file.name,
                    mimeType: file.type,
                    parents: [FOLDER_ID]
                };

                let formData = new FormData();
                formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
                formData.append("file", file);

                let response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                    method: "POST",
                    headers: { Authorization: `Bearer ${accessToken}` },
                    body: formData
                });

                let data = await response.json();
                imageIds.push(data.id);
            }

            document.getElementById("image").value = imageIds.join(",");
            alert("Все фото загружены! ID: " + imageIds.join(", "));
        }

        // Добавление товара
        async function addProduct() {
            if (!accessToken) return alert("Авторизуйтесь!");
            let name = document.getElementById("name").value.trim();
            let price = document.getElementById("price").value.trim();
            let image = document.getElementById("image").value.trim();

            if (!name || !price || !image) return alert("Заполните все поля!");

            let productId = Date.now().toString();
            let productData = JSON.stringify({ id: productId, name, price, image: image.split(",") });

            await createProductFile(productId, productData);
        }

        // Создание JSON файла в Google Drive
        async function createProductFile(productId, productData) {
            let metadata = {
                name: `${productId}.txt`,
                mimeType: "text/plain",
                parents: [FOLDER_ID]
            };

            let formData = new FormData();
            formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            formData.append("file", new Blob([productData], { type: "text/plain" }));

            let response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST",
                headers: { Authorization: `Bearer ${accessToken}` },
                body: formData
            });

            let data = await response.json();
            alert("Товар добавлен! ID файла: " + data.id);
        }

        // Удаление товара
        async function deleteProduct() {
            if (!accessToken) return alert("Авторизуйтесь!");
            let deleteId = document.getElementById("deleteId").value.trim();
            if (!deleteId) return alert("Введите ID товара!");

            let response = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${deleteId}.txt'&spaces=drive`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            let data = await response.json();
            if (data.files.length > 0) {
                let fileId = data.files[0].id;
                await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                alert("Товар удалён!");
            } else {
                alert("Файл не найден!");
            }
        }
    </script>

</body>
</html>
