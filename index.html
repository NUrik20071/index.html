<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <h2>Управление товарами</h2>

    <button onclick="authenticate()">Авторизоваться</button><br><br>

    <h3>Загрузить изображение</h3>
    <input type="file" id="imageInput" accept="image/*"><br><br>
    <button onclick="uploadImage()">Загрузить изображение</button><br><br>

    <h3>Загрузить список товаров</h3>
    <input type="file" id="fileInput" accept=".txt"><br><br>
    <button onclick="uploadFile()">Загрузить новый .txt</button>

    <h3>Удалить товар</h3>
    <input type="text" id="deleteFileId" placeholder="Введите ID файла"><br><br>
    <button onclick="deleteFile()">Удалить товар</button>

    <h3>Список загруженных товаров:</h3>
    <pre id="fileList"></pre>

    <script>
        const CLIENT_ID = "531826501379-e2hpum3jrta7u2q2s255ubvn23ie559j.apps.googleusercontent.com";
        const SCOPES = "https://www.googleapis.com/auth/drive.file";
        const FOLDER_ID = "ID_ПАПКИ_С_ТОВАРАМИ"; 

        let accessToken = "";

        function authenticate() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    alert("Авторизация успешна!");
                    fetchProducts();
                },
            }).requestAccessToken();
        }

        async function uploadImage() {
            const fileInput = document.getElementById("imageInput");
            const file = fileInput.files[0];

            if (!file || !accessToken) return alert("Выберите изображение и авторизуйтесь!");

            const metadata = { name: file.name, mimeType: file.type, parents: [FOLDER_ID] };
            const formData = new FormData();
            formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            formData.append("file", file);

            const response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST", headers: { Authorization: "Bearer " + accessToken }, body: formData
            });

            const data = await response.json();
            alert(data.id ? "Изображение загружено! ID: " + data.id : "Ошибка загрузки!");
        }

        async function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];

            if (!file || !accessToken) return alert("Выберите .txt файл и авторизуйтесь!");

            const metadata = { name: "products.txt", mimeType: "text/plain", parents: [FOLDER_ID] };
            const formData = new FormData();
            formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            formData.append("file", file);

            const response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST", headers: { Authorization: "Bearer " + accessToken }, body: formData
            });

            const data = await response.json();
            alert(data.id ? "Файл обновлен! ID: " + data.id : "Ошибка загрузки!");
            fetchProducts();
        }

        async function deleteFile() {
            const fileId = document.getElementById("deleteFileId").value;
            if (!fileId || !accessToken) return alert("Введите ID файла и авторизуйтесь!");

            const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                method: "DELETE", headers: { Authorization: `Bearer ${accessToken}` }
            });

            alert(response.ok ? "Файл удален!" : "Ошибка удаления!");
            fetchProducts();
        }

        async function fetchProducts() {
            if (!accessToken) return;

            const response = await fetch(`https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents`, {
                method: "GET", headers: { Authorization: `Bearer ${accessToken}` }
            });

            const data = await response.json();
            document.getElementById("fileList").innerText = data.files ? 
                data.files.map(file => `${file.name} - ID: ${file.id}`).join("\n") : "Ошибка загрузки списка!";
        }
    </script>
</body>
</html>
