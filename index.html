<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { max-width: 600px; margin: auto; }
        input, button { display: block; width: 100%; margin: 10px 0; padding: 10px; }
        .hidden { display: none; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; }
        .product-list { margin-top: 20px; }
        .product-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border: 1px solid #ccc; margin: 5px 0; }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>Админка</h1>

    <!-- Авторизация -->
    <div id="auth-section">
        <button onclick="authenticate()">Авторизоваться</button>
    </div>

    <!-- Админ-панель -->
    <div id="admin-section" class="hidden">
        <img id="avatar" class="avatar">
        <h2>Добавить товар</h2>
        <div class="container">
            <input type="text" id="name" placeholder="Название товара">
            <input type="number" id="price" placeholder="Цена">
            <input type="file" id="image" accept="image/*" multiple>
            <button onclick="uploadImages()">Загрузить фото</button>
            <button onclick="addProduct()">Добавить товар</button>
        </div>

        <h2>Список товаров</h2>
        <div id="product-list" class="product-list"></div>
    </div>

    <script>
        const CLIENT_ID = "ТВОЙ_CLIENT_ID.apps.googleusercontent.com";
        const SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile";
        const FOLDER_ID = "17tKKmWurcoRZi96oI7ujB25uMNhUOy78"; // ID папки Google Drive
        let accessToken = localStorage.getItem("access_token");
        let uploadedImageId = "";

        function authenticate() {
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                prompt: 'select_account',
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    localStorage.setItem("access_token", accessToken);
                    fetchUserInfo();
                },
            });
            tokenClient.requestAccessToken();
        }

        function fetchUserInfo() {
            fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
                headers: { Authorization: `Bearer ${accessToken}` }
            })
            .then(res => res.json())
            .then(user => {
                document.getElementById("auth-section").classList.add("hidden");
                document.getElementById("admin-section").classList.remove("hidden");
                document.getElementById("avatar").src = user.picture;
                loadProducts();
            })
            .catch(() => {
                localStorage.removeItem("access_token");
                alert("Ошибка авторизации. Попробуйте снова.");
            });
        }

        if (accessToken) fetchUserInfo();

        async function uploadImages() {
            let fileInput = document.getElementById("image");
            let file = fileInput.files[0];
            if (!file) return alert("Выберите изображение!");

            let metadata = {
                name: file.name,
                mimeType: file.type,
                parents: [FOLDER_ID]
            };

            let formData = new FormData();
            formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            formData.append("file", file);

            let response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST",
                headers: { Authorization: `Bearer ${accessToken}` },
                body: formData
            });

            let data = await response.json();
            uploadedImageId = data.id;
            alert("Фото загружено!");
        }

        async function addProduct() {
            let name = document.getElementById("name").value.trim();
            let price = document.getElementById("price").value.trim();

            if (!name || !price || !uploadedImageId) return alert("Заполните все поля!");

            let productId = Date.now().toString();
            let productData = JSON.stringify({ id: productId, name, price, image: uploadedImageId });

            let metadata = {
                name: `${productId}.txt`,
                mimeType: "text/plain",
                parents: [FOLDER_ID]
            };

            let formData = new FormData();
            formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            formData.append("file", new Blob([productData], { type: "text/plain" }));

            let response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST",
                headers: { Authorization: `Bearer ${accessToken}` },
                body: formData
            });

            let data = await response.json();
            alert("Товар добавлен!");
            loadProducts();
        }

        async function loadProducts() {
            let response = await fetch(`https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType='text/plain'&fields=files(id,name)`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            let data = await response.json();
            let productList = document.getElementById("product-list");
            productList.innerHTML = "";

            for (let file of data.files) {
                let fileData = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                }).then(res => res.json());

                let productDiv = document.createElement("div");
                productDiv.className = "product-item";
                productDiv.innerHTML = `
                    <img src="https://drive.google.com/thumbnail?id=${fileData.image}" class="product-img">
                    <span>${fileData.name} - ${fileData.price} руб.</span>
                    <button onclick="deleteProduct('${file.id}')">Удалить</button>
                `;
                productList.appendChild(productDiv);
            }
        }

        async function deleteProduct(fileId) {
            await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            alert("Товар удалён!");
            loadProducts();
        }
    </script>

</body>
</html>
