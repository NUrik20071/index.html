<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { max-width: 400px; margin: auto; }
        input, button { display: block; width: 100%; margin: 10px 0; padding: 10px; }
    </style>
</head>
<body>

    <h1>Админка</h1>

    <div class="container">
        <input type="text" id="name" placeholder="Название товара">
        <input type="number" id="price" placeholder="Цена">
        <input type="text" id="image" placeholder="ID изображения Google Drive">
        <button onclick="addProduct()">Добавить товар</button>
        <input type="text" id="deleteId" placeholder="ID товара для удаления">
        <button onclick="deleteProduct()">Удалить товар</button>
    </div>

    <script>
        let accessToken = ""; // Здесь будет храниться токен

        function authenticate() {
            return new Promise((resolve, reject) => {
                const clientId = "ТВОЙ_CLIENT_ID.apps.googleusercontent.com";
                const scope = "https://www.googleapis.com/auth/drive.file";
                const authUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${clientId}&redirect_uri=${window.location.origin}&response_type=token&scope=${scope}`;

                let popup = window.open(authUrl, "authPopup", "width=500,height=600");
                let checkPopup = setInterval(() => {
                    try {
                        if (!popup || popup.closed) {
                            clearInterval(checkPopup);
                            reject("Окно закрыто");
                        }
                        if (popup.location.hash) {
                            let params = new URLSearchParams(popup.location.hash.substring(1));
                            accessToken = params.get("access_token");
                            popup.close();
                            clearInterval(checkPopup);
                            resolve();
                        }
                    } catch (e) {}
                }, 1000);
            });
        }

        async function addProduct() {
            if (!accessToken) await authenticate();
            let name = document.getElementById("name").value.trim();
            let price = document.getElementById("price").value.trim();
            let image = document.getElementById("image").value.trim();

            if (!name || !price || !image) {
                alert("Заполните все поля!");
                return;
            }

            let productId = Date.now().toString();
            let productData = JSON.stringify({ id: productId, name, price, image });

            await createProductFile(productId, productData);
        }

        async function createProductFile(productId, productData) {
            let metadata = {
                name: `${productId}.txt`,
                mimeType: "text/plain"
            };

            let formData = new FormData();
            formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            formData.append("file", new Blob([productData], { type: "text/plain" }));

            let response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST",
                headers: { Authorization: "Bearer " + accessToken },
                body: formData
            });

            let data = await response.json();
            alert("Товар добавлен! ID файла: " + data.id);
        }

        async function deleteProduct() {
            if (!accessToken) await authenticate();
            let deleteId = document.getElementById("deleteId").value.trim();
            if (!deleteId) {
                alert("Введите ID товара!");
                return;
            }

            await deleteProductFile(deleteId);
        }

        async function deleteProductFile(productId) {
            let response = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${productId}.txt'&spaces=drive`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            let data = await response.json();
            if (data.files.length > 0) {
                let fileId = data.files[0].id;
                await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                alert("Товар удалён!");
            } else {
                alert("Файл не найден!");
            }
        }
    </script>

</body>
</html>
